#version 330 core
layout(location = 0) in uint inID;

out vec3 outModel;
out vec3 outPos;
out vec2 outUV;
out vec4 outCol;
out vec3 outNormal;
out float outAO;
flat out int selected;

uniform mat4 model;
uniform mat4 view;
uniform mat4 projection;
uniform vec3 chCol;

const float CUBE[8*5] = float[8*5](
  -0.5f, -0.5f, -0.5f, 0.0f, 0.0f,  /* left   bottom  back  0 */
  -0.5f, 0.5f, -0.5f, 0.0f, 0.5f,   /* left   top     back  1 */
  0.5f, -0.5f, -0.5f, 0.5f, 0.0f,   /* right  bottom  back  2 */
  0.5f, 0.5f, -0.5f, 0.5f, 0.5f,    /* right  top     back  3 */
  -0.5f, -0.5f, 0.5f, 0.0f, 0.0f,   /* left   bottom  front 4 */
  -0.5f, 0.5f, 0.5f, 0.0f, 0.5f,    /* left   top     front 5 */
  0.5f, -0.5f, 0.5f, 0.5f, 0.0f,    /* right  bottom  front 6 */
  0.5f, 0.5f, 0.5f, 0.5f, 0.5f      /* right   top    front 7 */
);

const vec3 NORMALS[6] = vec3[6](
  vec3(0.0, 0.0, -1.0),
  vec3(0.0, 1.0, 0.0),
  vec3(0.0, 0.0, 1.0),
  vec3(0.0, -1.0, 0.0),
  vec3(-1.0, 0.0, 0.0),
  vec3(1.0, 0.0, 0.0));

int CountBits(int x, int bitlength) {
  int r = 0;
  int i = 0;
  for(i = 0; i < bitlength; i++) {
    r += ((x & (1 << i)) != 0) ? 0 : 1; 
  }
  return r;
}

const float AO[5] = float[5](0.4, 0.6, 0.8, 1.0, 1.0);

void main() {
  vec4 finalCol = vec4(chCol, 1.0);
  float s = 1.0;
  int i = int(inID);
  int x = (i) & 0x3F;
  int y = (i >> 6) & 0x3F;
  int z = (i >> 12) & 0x3F;
  int v = (i >> 18) & 0x7;
  int n = (i >> 21) & 0x7;
  int ao = (i >> 24) & 0xFF;
  int c = v*5;
  vec3 normal = NORMALS[n];
  vec4 pos = vec4(CUBE[c] + x, CUBE[c + 1] + z, CUBE[c + 2] + y, 1.0);
  vec2 uv = vec2(CUBE[c + 3], CUBE[c + 4]);
  outUV = uv;
  outModel = (model*pos).xyz;
  outPos = pos.xyz;
  outCol = finalCol; 
  outNormal = normal;
  outAO = AO[ao];
  gl_Position = projection * view * model * pos;
};

